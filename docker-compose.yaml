services:
  gpsd:
    build:
      context: .
      dockerfile: Dockerfile.gpsd
    container_name: gpsd
    devices:
      - /dev/ttyACM0:/dev/ttyACM0
    ports:
      - "2947:2947"
    environment:
      - TZ=UTC
      - GPS_DEVICE=/dev/ttyACM0
      - PPS_DEVICE=
      - GPS_SPEED=38400
      - DEBUG_LEVEL=3
    cap_add:
      - SYS_TIME
      - SYS_NICE
    restart: unless-stopped
    ipc: shareable
    # depends_on:
    #   chrony:
    #     condition: service_healthy

  chrony:
    build:
      context: .
      dockerfile: Dockerfile.chrony
    container_name: chrony
    ports:
      - "123:123/udp"
      - "323:323/udp"
    volumes:
      #- gpsd_socket:/run/:rw
      - ./chrony/chrony.conf:/etc/chrony/chrony.conf:ro
    environment:
      - TZ=UTC
      - LOG_LEVEL=0   # 0 = information, higher gets lower
    ipc: service:gpsd
    cap_add:
      - SYS_TIME
      - SYS_NICE
    restart: unless-stopped
    depends_on:
     gpsd:
       condition: service_healthy

  exporter:
    build:
      context: .
      dockerfile: Dockerfile.exporter
    container_name: exporter
    ports:
      - "9978:9978/tcp"
    environment:
      - TZ=UTC
    depends_on:
      gpsd:
        condition: service_healthy

# volumes:
#   gpsd_socket:
